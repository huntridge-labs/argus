#!/bin/sh
echo "Running .husky pre-push hook"

# Check if we have the necessary dependencies to run tests
# (node, python, pytest). If not, skip tests with a warning.
if ! command -v node >/dev/null 2>&1; then
  echo "âš ï¸  Node.js not found. Skipping local tests (CI will run them)."
  exit 0
fi

# Activate virtual environment if it exists (support both .venv and .dev.venv)
if [ -f ".dev.venv/bin/activate" ]; then
  . .dev.venv/bin/activate
elif [ -f ".venv/bin/activate" ]; then
  . .venv/bin/activate
fi

# Check if pytest is available (needed for npm test)
if ! command -v pytest >/dev/null 2>&1 && [ ! -f ".dev.venv/bin/pytest" ]; then
  echo "âš ï¸  Python test dependencies not installed. Skipping local tests."
  echo "ğŸ’¡ To run tests locally, use the devcontainer or run: bash .devcontainer/setup.sh"
  echo "âœ… CI will run all tests on push."
  exit 0
fi

echo "â³ Running full test suite (bash, javascript, python, action validation)..."
npm test

if [ $? -ne 0 ]; then
  echo "âŒ Tests failed. Fix issues before pushing."
  exit 1
fi

echo "âœ… All tests passed! Safe to push."
