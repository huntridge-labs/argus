name: Validate Examples

# This workflow validates example workflow files to ensure they work correctly
# by dynamically discovering and testing examples without code duplication

on:
  pull_request:
    paths:
      - 'examples/**'
      - '.github/actions/**'
      - '.github/workflows/test-examples-functional.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  actions: read

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'

jobs:
  # ============================================================================
  # Discover and Validate All Example Files
  # ============================================================================
  discover-examples:
    name: Discover Example Files
    runs-on: ubuntu-latest
    outputs:
      workflow-examples: ${{ steps.discover.outputs.workflow-examples }}
      config-examples: ${{ steps.discover.outputs.config-examples }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Discover example files
        id: discover
        run: |
          # Find workflow examples (simple - just in workflows/ subdirectory)
          WORKFLOW_EXAMPLES=$(find examples/workflows -name "*.yml" -type f 2>/dev/null | jq -R -s -c 'split("\n")[:-1]')
          echo "workflow-examples=$WORKFLOW_EXAMPLES" >> $GITHUB_OUTPUT

          echo "## Discovered Examples" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Examples:**" >> $GITHUB_STEP_SUMMARY
          echo "$WORKFLOW_EXAMPLES" | jq -r '.[]' | while read file; do
            [ -n "$file" ] && echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
          done

  # ============================================================================
  # Validate Syntax, References, and Structure
  # ============================================================================
  validate-examples:
    name: Validate ${{ matrix.example }}
    runs-on: ubuntu-latest
    needs: discover-examples
    timeout-minutes: 5
    strategy:
      fail-fast: false
      matrix:
        example: ${{ fromJson(needs.discover-examples.outputs.workflow-examples) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install PyYAML
        run: pip install PyYAML

      - name: Validate YAML syntax
        run: |
          echo "Validating: ${{ matrix.example }}"
          python -c "import yaml; yaml.safe_load(open('${{ matrix.example }}'))"
          echo "✅ Valid YAML syntax" >> $GITHUB_STEP_SUMMARY

      - name: Validate action references
        run: |
          # Extract and validate action paths exist locally
          REMOTE_ACTIONS=$(grep -oE 'huntridge-labs/argus\.github/actions/[^@[:space:]]+' "${{ matrix.example }}" || true)

          ERRORS=0
          for action in $REMOTE_ACTIONS; do
            # Remove the repo prefix to get local path
            LOCAL_PATH="${action#huntridge-labs/argus}"

            if [ ! -d "$LOCAL_PATH" ]; then
              echo "❌ **Referenced action does not exist:** \`$action\`" >> $GITHUB_STEP_SUMMARY
              ERRORS=$((ERRORS + 1))
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            exit 1
          fi

          echo "✅ All action references valid" >> $GITHUB_STEP_SUMMARY

      - name: Validate required structure
        run: |
          # Check that workflow has required elements
          if ! grep -q "name:" "${{ matrix.example }}"; then
            echo "❌ **Missing workflow name**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          if ! grep -q "on:" "${{ matrix.example }}"; then
            echo "❌ **Missing trigger (on:)**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          if ! grep -q "jobs:" "${{ matrix.example }}"; then
            echo "❌ **Missing jobs definition**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "✅ Required workflow structure present" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Validate Configuration Examples
  # ============================================================================
  validate-configs:
    name: Validate Config Files
    runs-on: ubuntu-latest
    needs: discover-examples
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Validate container configs
        run: |
          echo "## Configuration Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          ERRORS=0

          # Validate container config examples
          for config in examples/configs/container-config.example.{yml,json}; do
            if [ -f "$config" ]; then
              echo "Testing: $config"

              # Validate it's valid YAML/JSON
              if [[ "$config" == *.yml ]]; then
                if python -c "import yaml; yaml.safe_load(open('$config'))" 2>/dev/null; then
                  echo "✅ \`$(basename $config)\` is valid YAML" >> $GITHUB_STEP_SUMMARY
                else
                  echo "❌ \`$(basename $config)\` invalid YAML syntax" >> $GITHUB_STEP_SUMMARY
                  ERRORS=$((ERRORS + 1))
                fi
              elif [[ "$config" == *.json ]]; then
                if python -c "import json; json.load(open('$config'))" 2>/dev/null; then
                  echo "✅ \`$(basename $config)\` is valid JSON" >> $GITHUB_STEP_SUMMARY
                else
                  echo "❌ \`$(basename $config)\` invalid JSON syntax" >> $GITHUB_STEP_SUMMARY
                  ERRORS=$((ERRORS + 1))
                fi
              fi
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            exit 1
          fi

      - name: Validate ZAP configs
        run: |
          for config in examples/configs/zap-config*.yml; do
            if [ -f "$config" ]; then
              echo "Validating: $config"
              python -c "import yaml; yaml.safe_load(open('$config'))"
              echo "✅ \`$(basename $config)\` is valid YAML" >> $GITHUB_STEP_SUMMARY
            fi
          done

  # ============================================================================
  # Final Summary
  # ============================================================================
  examples-summary:
    name: Examples Validation Summary
    runs-on: ubuntu-latest
    needs:
      - validate-examples
      - validate-configs
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "# Example Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Validation Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Examples | ${{ needs.validate-examples.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Config Examples | ${{ needs.validate-configs.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note**: Functional testing of actions is handled by \`test-actions.yml\`" >> $GITHUB_STEP_SUMMARY
          echo "> This workflow focuses on validating example **documentation** is correct." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.validate-examples.result }}" == "success" && \
                "${{ needs.validate-configs.result }}" == "success" ]]; then
            echo "✅ **All examples validated successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Some validations failed - review above for details**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
