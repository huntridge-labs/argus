name: Container Scan from Config

# Reusable workflow for scanning multiple container images defined in a config file.
# Uses composite actions - no script checkouts needed.
#
# Usage Example:
#   permissions:
#     contents: read
#     security-events: write
#     actions: read
#     pull-requests: write
#     checks: write
#     id-token: write
#     packages: read
#   jobs:
#     scan:
#       uses: huntridge-labs/argus/.github/workflows/container-scan-from-config.yml@0.3.0
#       with:
#         config_file: 'containers.yml'
#       secrets: inherit  # Required for dynamic secret resolution
#
# Config File Format (YAML example):
#   containers:
#     - name: my-app
#       image: myregistry.io/my-app:latest
#       registry:
#         auth_secret: MY_REGISTRY_TOKEN  # Any secret name from your repo
#       scanners: [trivy, grype]
#
# How Secret Resolution Works:
# 1. Your config specifies auth_secret: "MY_REGISTRY_TOKEN" (any secret name)
# 2. You use secrets: inherit to pass ALL your repo secrets to this workflow
# 3. This workflow uses secrets[matrix.registry_auth_secret] to resolve dynamically
# 4. The secret value is passed to scanner-container as registry_password
#
# IMPORTANT: You MUST use 'secrets: inherit' for this to work.
# This allows the workflow to dynamically access whichever secret your config references.
#
# Required Permissions (caller must grant these):
#   contents: read          - Checkout repository and read config files
#   security-events: write  - Upload SARIF results to GitHub Security tab
#   actions: read           - Download artifacts from scanner jobs
#   pull-requests: write    - Post PR comments with scan results
#   checks: write           - Create check runs for scan results
#   id-token: write         - OIDC token for registry authentication
#   packages: read          - Pull container images from GitHub Packages

on:
  workflow_dispatch:
    inputs:
      config_file:
        description: 'Path to container config file (YAML, JSON, or JS)'
        required: false
        default: 'examples/container-config.example.yml'
        type: string
  workflow_call:
    inputs:
      config_file:
        description: 'Path to container config file (YAML, JSON, or JS)'
        required: false
        default: 'examples/container-config.example.yml'
        type: string
    # No explicit secrets declared - callers MUST use 'secrets: inherit'
    # This allows dynamic secret resolution via secrets[matrix.registry_auth_secret]

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write
  checks: write
  id-token: write
  packages: read

env:
  # Use current branch/PR when testing in argus repo, otherwise use release tag
  HRL_REF: ${{ github.repository == 'huntridge-labs/argus' && (github.head_ref || github.ref_name) || '0.3.0' }}

jobs:
  parse-config:
    name: Parse Container Config
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.parse.outputs.matrix }}
      has_containers: ${{ steps.parse.outputs.has_containers }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Parse container config
        id: parse
        uses: huntridge-labs/argus/.github/actions/parse-container-config@0.3.0
        with:
          config_file: ${{ inputs.config_file }}

  scan-containers:
    name: Scan ${{ matrix.name }}
    needs: parse-config
    if: needs.parse-config.outputs.has_containers == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix: ${{ fromJson(needs.parse-config.outputs.matrix) }}
    steps:
      - name: Run container security scanners
        uses: huntridge-labs/argus/.github/actions/scanner-container@0.3.0
        with:
          scan_mode: 'remote'
          image_ref: ${{ matrix.image }}
          container_name: ${{ matrix.name }}
          registry_username: ${{ matrix.registry_username }}
          registry_password: ${{ secrets[matrix.registry_auth_secret] }}
          scanners: ${{ matrix.scanners }}
          fail_on_severity: ${{ matrix.fail_on_severity }}
          enable_code_security: ${{ matrix.enable_code_security }}
          post_pr_comment: false
          skip_summary: 'true'

  scan-summary:
    name: Container Scan Summary
    runs-on: ubuntu-latest
    needs: [parse-config, scan-containers]
    if: always()
    steps:
      - name: Generate container scan summary
        uses: huntridge-labs/argus/.github/actions/scanner-container-summary@0.3.0
        with:
          post_pr_comment: ${{ github.event_name == 'pull_request' && 'true' || 'false' }}
